#!/usr/bin/env zsh

set -euo pipefail

if [[ $# -lt 1 ]]; then
   echo "Usage: $0 [root directory]"
   exit 1
fi

root_dir="$1"
if [[ ! -d "$root_dir/src/mlir" ]]; then
    echo "Error: expected $root_dir to heuristically be an LLVM checkout"
    exit 1
fi

pushd "$root_dir"
if [[ -d "$root_dir/.direnv/python-uv" ]]; then
    uv venv --python python3 "$root_dir/.direnv/python-uv"
fi
if [[ ! -a "$root_dir/.envrc" ]]; then
    echo 'export VIRTUAL_ENV=$(direnv_layout_dir)/python-uv' >.envrc
    echo "PATH_add $root_dir/build/bin" '"${VIRTUAL_ENV}/bin"' >>.envrc
    direnv allow .
fi
eval "$(direnv export zsh)"
echo "Installing Python dependencies..."
uv pip install -q -r "$root_dir/src/mlir/python/requirements.txt"
uv pip install -q pygments # LLVM needs this

if [[ ! -a "$root_dir/src/compile_commands.json" ]]; then
    ln -s "$root_dir/build/compile_commands.json" "src/compile_commands.json"
fi
if [[ ! -a "$root_dir/src/tablegen_compile_commands.yml" ]]; then
    ln -s "$root_dir/build/tablegen_compile_commands.yml" "src/tablegen_compile_commands.yml"
fi

echo "Set up LLVM build environment in $root_dir"
popd
